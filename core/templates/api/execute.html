{% extends "common/main.html"%}
{% load backend_tags %}

{% block style %}

{% endblock %}


{% block table %}

<h4 class="font-w600 mb-2 mr-auto ">执行面板</h4>


<div class="col-xl-12">
    <div class="card">
        <div class="card-body">
            <div class="row align-items-end">
                <div class="col">
                    <div class="row">
                        <div class="col-sm-4">
                            <div class="mb-4">
                                <p class="mb-2">归属条目</p>
                                <h4 class="text-black">{{selected_obj.name}}{{selected_obj.module}}</h4>
                            </div>
                            <div class="mb-4">
                                <p class="mb-2">测试时间</p>
                                <h4 class="text-black">{{selected_obj.create_time}}</h4>
                            </div>

                        </div>
                        <div class="col-sm-4">
                            <div class="mb-4">
                                <p class="mb-2">共计数</p>
                                <h4 class="text-black">32</h4>
                            </div>
                            <div class="mb-4">
                                <p class="mb-2">有效数</p>
                                <h4 class="text-black">12</h4>
                            </div>

                        </div>
                        <div class="col-sm-4">
                            <div id="success-rate"></div>

                        </div>

                    </div>

                </div>
            </div>

        </div>
    </div>
</div>


<div class="card">
    <div class="card-header">
        <h5 class="card-title">关联的有效数据</h5>
    </div>
    <div class="card-body">

        <div>
            <table class="table" style="font-size: smaller">
                {% display_all_related_data selected_obj True %}
            </table>
        </div>



        <div class="row col-md-12">
            <div class="col-md-11">
                <a href="#" onclick="javascript:history.back(-1);" role="button"
                   class="btn btn-sm btn-rounded btn-dark">取消</a>
            </div>
            <div class="basic-form col-md-1">
<!--                <form method="post" onsubmit="return ActionValidation(this)">{% csrf_token %}-->
                <form id="execute_form">{% csrf_token %}
                    <input id="execute_submit" type="submit" class="btn btn-sm btn-rounded btn-warning" value="执行">
                </form>
            </div>

        </div>
    </div>
</div>

<div>
    <div  class="progress-div">
        <div class="progress">
            <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="2" aria-valuemin="0" aria-valuemax="100" style="min-width: 2em; width: 2%;">
                2%
            </div>
        </div>
    </div>


     <div class="progress-text progress-bar-striped active"  role="progressbar" aria-valuenow="2" aria-valuemin="0" aria-valuemax="100" style="min-width: 2em; width: 2%;">

</div>

<!--<div>-->
<!--    <iframe src="{{html_file}}" name="i" id="urlIframe" width="100%" height="100%" frameborder="0" scrolling="true"-->
<!--        marginheight="5" marginwidth="5" onload="reinitIframe()"></iframe>-->
<!--</div>-->

<div>
    <iframe name="i" id="urlIframe" width="100%" height="100%" frameborder="0" scrolling="true"
        marginheight="5" marginwidth="5" onload="reinitIframe()"></iframe>
</div>

</div>

{% endblock %}

{% block javascript %}
<script>
	$(document).ready(function () {
		var options = {
			  series: [70],
			  chart: {
				  foreColor: '#9ba7b2',
			  height: 180,
			  type: 'radialBar',
			},
			plotOptions: {
			  radialBar: {
				hollow: {
				  size: '70%',
				}
			  },
			},
			labels: ['成功率'],
			};

			var chart = new ApexCharts(document.querySelector("#success-rate"), options);
			chart.render();

		});


		//设置iframe自适应高度和宽度
		function reinitIframe() {
			var iframe = document.getElementById("urlIframe");
			try{
					var bHeight = iframe.contentWindow.document.body.scrollHeight;
					iframe.height = bHeight;
				} catch (ex) { }
		};


		$(function () {

			//提交JSON格式化模态框中的数据
			$('#execute_form').on('submit', function () {

			var sitv = setInterval(function(){
                    var prog_url = '/show_progress'              // prog_url指请求进度的url，后面会在django中设置
                    $.getJSON(prog_url, function(number_process){

                        $('.progress-div').css('visibility', 'visible');
                        $('.progress-bar').css('width', number_process + '%');
                        $('.progress-bar').text(number_process + '%');
                        $('.progress-text').text( '显示日志'+log );
                        $('.progress-text').css('width', '100%');

                         if(number_process == "99"){
                            clearInterval(sitv);
                            $('.progress-bar').css('width', '100%');
                            $('.progress-bar').text('100%');
                        }
                    });
                }, 1);



				csrftoken = $('[name="csrfmiddlewaretoken"]').val();
				selected_ids = [];//要提交到后台的数据
                $("input[tag='obj_checkbox']").each(function () {
                    if ($(this).prop("checked")) {////用于chekbox,radio   一个形参,获取值  两个形参 设置值
                        selected_ids.push($(this).val());
                    }
                });
                selected_ids = selected_ids.toString();
				$.ajax({
					type: "POST",
					dataType: "JSON",
					url: "/ajax/api/execute/",
					data: {"model":"{{model_name}}","selected":selected_ids,"selected_id":"{{selected_id}}", "csrfmiddlewaretoken": csrftoken},
					contentType: 'application/x-www-form-urlencoded',
					success: function (res) {
						if (res.success){
                            $("#urlIframe").removeAttr("src");
							var data_str = res.data;
							$("#urlIframe").attr("src",data_str);
							clearInterval(sitv)
						}else{
							var error = '错误码：'+res.code+'，'+'原因：'+res.message;
							swal({
                                text:error,
                                type:'error'
                            });
						}

					},
					error: function (jqXHR,textStatus,errorThrown) {
							var error = '错误码：'+textStatus+'，'+'原因：'+errorThrown;

							swal({
                                text:error,
                                type:'error'
                            });
					}
				});
				return false;
			});
		});

</script>
{% endblock %}